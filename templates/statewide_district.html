{% extends "base.html" %}

{% block title %}{{ info.office }} District {{ info.district }} - NH Election Results{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
#district-map {
    height: 200px;
    width: 100%;
    background: #f5f5f5;
    border-radius: 4px;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        {% if info.office == 'State Senator' %}State Senate{% elif info.office == 'Executive Councilor' %}Executive Council{% elif info.office == 'Representative in Congress' %}US Congress{% else %}{{ info.office }}{% endif %} District {{ info.district }}
        <span class="lean {% if 'R' in lean %}r{% else %}d{% endif %}">{{ lean }}</span>
    </h1>
    <p class="subtitle">{{ info.towns|length }} towns</p>
</div>

<div class="metrics">
    <div class="metric">
        <div class="metric-value {% if pvi.current_pvi > 0 %}r{% else %}d{% endif %}">
            {% if pvi.current_pvi > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(pvi.current_pvi|abs) }}
        </div>
        <div class="metric-label">PVI</div>
    </div>
    <div class="metric">
        <div class="metric-value {% if pvi.trend > 0 %}r{% else %}d{% endif %}">
            {% if pvi.trend > 0 %}+{% endif %}{{ "%.1f"|format(pvi.trend) }}
        </div>
        <div class="metric-label">Trend</div>
    </div>
    {% if by_year %}
    {% set latest = by_year.keys()|list|sort|last %}
    <div class="metric">
        <div class="metric-value">
            <span class="r">{{ by_year[latest].r_seats }}</span>-<span class="d">{{ by_year[latest].d_seats }}</span>
        </div>
        <div class="metric-label">{{ latest }} Result</div>
    </div>
    {% endif %}
</div>

<div class="two-col">
    <div class="main-content">
        <div class="section">
            <h2>Election History</h2>

            {% for year in by_year.keys()|sort(reverse=true) %}
            {% set data = by_year[year] %}
            <div class="election-year">
                <div class="election-year-header">
                    <h3>{{ year }} &mdash;
                        {% if data.r_seats > data.d_seats %}
                        <span class="r">R Win</span>
                        {% elif data.d_seats > data.r_seats %}
                        <span class="d">D Win</span>
                        {% else %}
                        Tie
                        {% endif %}
                    </h3>
                    <span class="{% if data.margin > 0 %}r{% else %}d{% endif %}">
                        {% if data.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(data.margin|abs) }}%
                    </span>
                </div>

                <ul class="candidates">
                    {% for candidate in data.candidates %}
                    <li class="candidate {% if candidate.is_winner %}winner{% endif %}">
                        <span class="candidate-name">{{ candidate.name }}</span>
                        <span class="candidate-party {% if candidate.party == 'Republican' %}r{% elif candidate.party == 'Democratic' %}d{% endif %}">{{ candidate.party or '-' }}</span>
                        <span class="candidate-votes">{{ "{:,}".format(candidate.votes) }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-section">
            <div id="district-map"></div>
        </div>

        {% if topline %}
        <div class="sidebar-section">
            <h3>Topline Results <span style="font-size:11px;font-weight:normal;color:#666;">(click year for details)</span></h3>
            <style>
                .topline-row { cursor: pointer; }
                .topline-row:hover { background: #f5f5f5; }
                .year-popover {
                    display: none;
                    position: fixed;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 16px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    min-width: 280px;
                    font-size: 13px;
                }
                .year-popover.active { display: block; }
                .year-popover h4 { margin: 0 0 12px; font-size: 15px; }
                .year-popover table { width: 100%; border-collapse: collapse; }
                .year-popover td { padding: 6px 8px; border-bottom: 1px solid #eee; }
                .year-popover tr:last-child td { border-bottom: none; }
                .year-popover .office-name { font-weight: 500; }
                .year-popover .votes { text-align: right; font-family: monospace; }
                .year-popover .margin { text-align: right; font-weight: 600; }
            </style>
            <table class="topline-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>President</th>
                        <th>Governor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year in topline.keys()|sort(reverse=true) %}
                    <tr class="topline-row" data-year="{{ year }}">
                        <td>{{ year }}</td>
                        <td>
                            {% if 'President of the United States' in topline[year] %}
                            {% set p = topline[year]['President of the United States'] %}
                            <span class="{% if p.margin > 0 %}r{% else %}d{% endif %}">
                                {% if p.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(p.margin|abs) }}
                            </span>
                            {% else %}&mdash;{% endif %}
                        </td>
                        <td>
                            {% if 'Governor' in topline[year] %}
                            {% set g = topline[year]['Governor'] %}
                            <span class="{% if g.margin > 0 %}r{% else %}d{% endif %}">
                                {% if g.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(g.margin|abs) }}
                            </span>
                            {% else %}&mdash;{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="year-popover" id="yearPopover"></div>
        <script>
        const toplineData = {{ topline|tojson }};
        const raceData = {{ by_year|tojson }};
        const officeName = "{{ info.office }}";

        document.querySelectorAll('.topline-row').forEach(row => {
            row.addEventListener('click', function(e) {
                const year = parseInt(this.dataset.year);
                const popover = document.getElementById('yearPopover');
                const rect = this.getBoundingClientRect();

                let html = `<h4>${year} Results in District</h4><table>`;

                // President
                if (toplineData[year] && toplineData[year]['President of the United States']) {
                    const p = toplineData[year]['President of the United States'];
                    const margin = p.margin > 0 ? `<span class="r">R+${p.margin.toFixed(1)}</span>` : `<span class="d">D+${Math.abs(p.margin).toFixed(1)}</span>`;
                    html += `<tr><td class="office-name">President</td><td class="votes"><span class="r">${p.r.toLocaleString()}</span> - <span class="d">${p.d.toLocaleString()}</span></td><td class="margin">${margin}</td></tr>`;
                }

                // Governor
                if (toplineData[year] && toplineData[year]['Governor']) {
                    const g = toplineData[year]['Governor'];
                    const margin = g.margin > 0 ? `<span class="r">R+${g.margin.toFixed(1)}</span>` : `<span class="d">D+${Math.abs(g.margin).toFixed(1)}</span>`;
                    html += `<tr><td class="office-name">Governor</td><td class="votes"><span class="r">${g.r.toLocaleString()}</span> - <span class="d">${g.d.toLocaleString()}</span></td><td class="margin">${margin}</td></tr>`;
                }

                // Current office race
                if (raceData[year]) {
                    const race = raceData[year];
                    const margin = race.margin > 0 ? `<span class="r">R+${race.margin.toFixed(1)}</span>` : `<span class="d">D+${Math.abs(race.margin).toFixed(1)}</span>`;
                    html += `<tr style="background:#f8f8f8;"><td class="office-name">${officeName}</td><td class="votes"><span class="r">${race.top_r.toLocaleString()}</span> - <span class="d">${race.top_d.toLocaleString()}</span></td><td class="margin">${margin}</td></tr>`;
                }

                html += '</table><p style="margin:8px 0 0;font-size:11px;color:#666;">Click elsewhere to close</p>';
                popover.innerHTML = html;

                // Position popover
                popover.style.top = (rect.bottom + 5) + 'px';
                popover.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
                popover.classList.add('active');
            });
        });

        // Close popover when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.topline-row') && !e.target.closest('.year-popover')) {
                document.getElementById('yearPopover').classList.remove('active');
            }
        });
        </script>
        {% endif %}

        {% if demographics and demographics.population %}
        <div class="sidebar-section">
            <h3>Demographics</h3>
            <table class="demo-table">
                <tr>
                    <td>Population</td>
                    <td class="text-right">{{ "{:,}".format(demographics.population) }}</td>
                </tr>
                {% if demographics.median_income %}
                <tr>
                    <td>Median Income</td>
                    <td class="text-right">${{ "{:,}".format(demographics.median_income) }}</td>
                </tr>
                {% endif %}
                {% if demographics.median_age %}
                <tr>
                    <td>Median Age</td>
                    <td class="text-right">{{ demographics.median_age }}</td>
                </tr>
                {% endif %}
                {% if demographics.college_pct %}
                <tr>
                    <td>College Degree+</td>
                    <td class="text-right">{{ demographics.college_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.homeowner_pct %}
                <tr>
                    <td>Homeowners</td>
                    <td class="text-right">{{ demographics.homeowner_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.veteran_pct %}
                <tr>
                    <td>Veterans</td>
                    <td class="text-right">{{ demographics.veteran_pct }}%</td>
                </tr>
                {% endif %}
            </table>

            <h4 style="margin-top: 1rem; font-size: 0.9rem;">Race & Ethnicity</h4>
            <table class="demo-table">
                {% if demographics.white_pct %}
                <tr>
                    <td>White</td>
                    <td class="text-right">{{ demographics.white_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.black_pct and demographics.black_pct >= 0.5 %}
                <tr>
                    <td>Black</td>
                    <td class="text-right">{{ demographics.black_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.asian_pct and demographics.asian_pct >= 0.5 %}
                <tr>
                    <td>Asian</td>
                    <td class="text-right">{{ demographics.asian_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.hispanic_pct and demographics.hispanic_pct >= 0.5 %}
                <tr>
                    <td>Hispanic/Latino</td>
                    <td class="text-right">{{ demographics.hispanic_pct }}%</td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% endif %}

        <div class="sidebar-section">
            <h3>Towns ({{ info.towns|length }})</h3>
            <ul class="town-list" style="columns: 1;">
                {% for town in info.towns %}
                <li><a href="{{ url_for('town', name=town) }}">{{ town }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const districtTowns = {{ info.towns | tojson }};
const townResults = {{ town_results | tojson }};

// Name normalization for unincorporated places
const nameMap = {
    'Atkinson & Gilmanton': 'Atkinson & Gilmanton Academy Grant',
    'Second College': 'Second College Grant',
    'Low & Burbanks': 'Low and Burbanks Grant',
    'Thompson & Meserve': 'Thompson and Meserves Purchase',
    "Pinkham's Grant": 'Pinkhams Grant',
    "Hart's Location": 'Harts Location',
    'Wentworths Location': "Wentworth's Location",
    "Wentworth's Location": 'Wentworths Location'
};

function normalizeGeoName(geoName) {
    return nameMap[geoName] || geoName;
}

// Color scale based on margin (positive = R, negative = D)
function getMarginColor(margin) {
    // Clamp margin to reasonable range for color intensity
    const intensity = Math.min(Math.abs(margin), 50) / 50;
    if (margin > 0) {
        // Republican - red shades
        const r = Math.round(139 + (116 * intensity));  // 139-255
        const g = Math.round(139 * (1 - intensity));     // 139-0
        const b = Math.round(139 * (1 - intensity));     // 139-0
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // Democratic - blue shades
        const r = Math.round(100 * (1 - intensity));     // 100-0
        const g = Math.round(100 + (50 * (1 - intensity)));  // 100-150
        const b = Math.round(139 + (116 * intensity));   // 139-255
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function getTownData(townName) {
    // Try exact match first
    if (townResults[townName]) return townResults[townName];
    // Try normalized name
    const normalized = nameMap[townName];
    if (normalized && townResults[normalized]) return townResults[normalized];
    // Try reverse lookup
    for (const [from, to] of Object.entries(nameMap)) {
        if (to === townName && townResults[from]) return townResults[from];
    }
    return null;
}

const map = L.map('district-map', {
    zoomControl: false,
    attributionControl: false,
    dragging: false,
    touchZoom: false,
    scrollWheelZoom: false,
    doubleClickZoom: false
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    maxZoom: 19
}).addTo(map);

fetch('/static/data/nh-towns.geojson')
    .then(r => r.json())
    .then(geojson => {
        const districtFeatures = geojson.features.filter(f => {
            const geoName = f.properties.name;
            const normalizedName = normalizeGeoName(geoName);
            return districtTowns.includes(geoName) || districtTowns.includes(normalizedName);
        });

        const layer = L.geoJSON(districtFeatures, {
            style: function(feature) {
                const townName = feature.properties.name;
                const data = getTownData(townName);
                const margin = data ? data.margin : 0;
                return {
                    fillColor: getMarginColor(margin),
                    weight: 1,
                    opacity: 1,
                    color: '#333',
                    fillOpacity: 0.7
                };
            },
            onEachFeature: function(feature, layer) {
                const townName = feature.properties.name;
                const data = getTownData(townName);
                if (data) {
                    const marginText = data.margin > 0 ? `R+${data.margin}` : `D+${Math.abs(data.margin)}`;
                    layer.bindTooltip(`<strong>${townName}</strong><br>${marginText}<br>R: ${data.r.toLocaleString()} | D: ${data.d.toLocaleString()}`, {
                        direction: 'top',
                        offset: [0, -5]
                    });
                }
            }
        }).addTo(map);

        if (layer.getBounds().isValid()) {
            map.fitBounds(layer.getBounds(), { padding: [10, 10] });
        }
    });
</script>
{% endblock %}
