{% extends "base.html" %}

{% block title %}{{ info.office }} District {{ info.district }} - NH Election Results{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        {% if info.office == 'State Senator' %}State Senate{% elif info.office == 'Executive Councilor' %}Executive Council{% elif info.office == 'Representative in Congress' %}US Congress{% else %}{{ info.office }}{% endif %} District {{ info.district }}
        <span class="lean {% if 'R' in lean %}r{% else %}d{% endif %}">{{ lean }}</span>
    </h1>
    <p class="subtitle">{{ info.towns|length }} towns</p>
</div>

<div class="metrics">
    <div class="metric">
        <div class="metric-value {% if pvi.current_pvi > 0 %}r{% else %}d{% endif %}">
            {% if pvi.current_pvi > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(pvi.current_pvi|abs) }}
        </div>
        <div class="metric-label">PVI</div>
    </div>
    <div class="metric">
        <div class="metric-value {% if pvi.trend > 0 %}r{% else %}d{% endif %}">
            {% if pvi.trend > 0 %}+{% endif %}{{ "%.1f"|format(pvi.trend) }}
        </div>
        <div class="metric-label">Trend</div>
    </div>
    {% if by_year %}
    {% set latest = by_year.keys()|list|sort|last %}
    <div class="metric">
        <div class="metric-value">
            <span class="r">{{ by_year[latest].r_seats }}</span>-<span class="d">{{ by_year[latest].d_seats }}</span>
        </div>
        <div class="metric-label">{{ latest }} Result</div>
    </div>
    {% endif %}
</div>

<div class="two-col">
    <div class="main-content">
        <div class="section">
            <h2>Election History</h2>

            {% for year in by_year.keys()|sort(reverse=true) %}
            {% set data = by_year[year] %}
            <div class="election-year">
                <div class="election-year-header">
                    <h3>{{ year }} &mdash;
                        {% if data.r_seats > data.d_seats %}
                        <span class="r">R Win</span>
                        {% elif data.d_seats > data.r_seats %}
                        <span class="d">D Win</span>
                        {% else %}
                        Tie
                        {% endif %}
                    </h3>
                    <span class="{% if data.margin > 0 %}r{% else %}d{% endif %}">
                        {% if data.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(data.margin|abs) }}%
                    </span>
                </div>

                <ul class="candidates">
                    {% for candidate in data.candidates %}
                    <li class="candidate {% if candidate.is_winner %}winner{% endif %}">
                        <span class="candidate-name">{{ candidate.name }}</span>
                        <span class="candidate-party {% if candidate.party == 'Republican' %}r{% elif candidate.party == 'Democratic' %}d{% endif %}">{{ candidate.party or '-' }}</span>
                        <span class="candidate-votes">{{ "{:,}".format(candidate.votes) }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>

    <aside class="sidebar">
        {% if topline %}
        <div class="sidebar-section">
            <h3>Topline Results</h3>
            <table class="topline-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>President</th>
                        <th>Governor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year in topline.keys()|sort(reverse=true) %}
                    <tr>
                        <td>{{ year }}</td>
                        <td>
                            {% if 'President of the United States' in topline[year] %}
                            {% set p = topline[year]['President of the United States'] %}
                            <span class="{% if p.margin > 0 %}r{% else %}d{% endif %}">
                                {% if p.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(p.margin|abs) }}
                            </span>
                            {% else %}&mdash;{% endif %}
                        </td>
                        <td>
                            {% if 'Governor' in topline[year] %}
                            {% set g = topline[year]['Governor'] %}
                            <span class="{% if g.margin > 0 %}r{% else %}d{% endif %}">
                                {% if g.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(g.margin|abs) }}
                            </span>
                            {% else %}&mdash;{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="sidebar-section">
            <h3>Towns ({{ info.towns|length }})</h3>
            <ul class="town-list" style="columns: 1;">
                {% for town in info.towns %}
                <li><a href="{{ url_for('town', name=town) }}">{{ town }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </aside>
</div>
{% endblock %}
