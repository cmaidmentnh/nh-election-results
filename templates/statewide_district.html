{% extends "base.html" %}

{% block title %}{{ info.office }} District {{ info.district }} - NH Election Results{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
#district-map {
    height: 200px;
    width: 100%;
    background: #f5f5f5;
    border-radius: 4px;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        {% if info.office == 'State Senator' %}State Senate{% elif info.office == 'Executive Councilor' %}Executive Council{% elif info.office == 'Representative in Congress' %}US Congress{% else %}{{ info.office }}{% endif %} District {{ info.district }}
        <span class="lean {% if 'R' in lean %}r{% else %}d{% endif %}">{{ lean }}</span>
    </h1>
    <p class="subtitle">{{ info.towns|length }} towns</p>
</div>

<div class="metrics">
    <div class="metric">
        <div class="metric-value {% if pvi.current_pvi > 0 %}r{% else %}d{% endif %}">
            {% if pvi.current_pvi > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(pvi.current_pvi|abs) }}
        </div>
        <div class="metric-label">PVI</div>
    </div>
    <div class="metric">
        <div class="metric-value {% if pvi.trend > 0 %}r{% else %}d{% endif %}">
            {% if pvi.trend > 0 %}+{% endif %}{{ "%.1f"|format(pvi.trend) }}
        </div>
        <div class="metric-label">Trend</div>
    </div>
    {% if by_year %}
    {% set latest = by_year.keys()|list|sort|last %}
    <div class="metric">
        <div class="metric-value">
            <span class="r">{{ by_year[latest].r_seats }}</span>-<span class="d">{{ by_year[latest].d_seats }}</span>
        </div>
        <div class="metric-label">{{ latest }} Result</div>
    </div>
    {% endif %}
</div>

<div class="two-col">
    <div class="main-content">
        <div class="section">
            <h2>Election History</h2>

            {% for year in by_year.keys()|sort(reverse=true) %}
            {% set data = by_year[year] %}
            <div class="election-year">
                <div class="election-year-header">
                    <h3>{{ year }} &mdash;
                        {% if data.r_seats > data.d_seats %}
                        <span class="r">R Win</span>
                        {% elif data.d_seats > data.r_seats %}
                        <span class="d">D Win</span>
                        {% else %}
                        Tie
                        {% endif %}
                    </h3>
                    <span class="{% if data.margin > 0 %}r{% else %}d{% endif %}">
                        {% if data.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(data.margin|abs) }}%
                    </span>
                </div>

                <ul class="candidates">
                    {% for candidate in data.candidates %}
                    <li class="candidate {% if candidate.is_winner %}winner{% endif %}">
                        <span class="candidate-name">{{ candidate.name }}</span>
                        <span class="candidate-party {% if candidate.party == 'Republican' %}r{% elif candidate.party == 'Democratic' %}d{% endif %}">{{ candidate.party or '-' }}</span>
                        <span class="candidate-votes">{{ "{:,}".format(candidate.votes) }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-section">
            <div id="district-map"></div>
        </div>

        {% if topline %}
        <div class="sidebar-section">
            <h3>Topline Results <span style="font-size:11px;font-weight:normal;color:#666;">(click for details)</span></h3>
            <table class="topline-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>President</th>
                        <th>Governor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year in topline.keys()|sort(reverse=true) %}
                    <tr>
                        <td>{{ year }}</td>
                        <td>
                            {% if 'President of the United States' in topline[year] %}
                            {% set p = topline[year]['President of the United States'] %}
                            <span class="topline-cell {% if p.margin > 0 %}r{% else %}d{% endif %}"
                                  data-r="{{ '{:,}'.format(p.r) }}" data-d="{{ '{:,}'.format(p.d) }}"
                                  title="R: {{ '{:,}'.format(p.r) }} | D: {{ '{:,}'.format(p.d) }}">
                                <span class="margin-display">{% if p.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(p.margin|abs) }}</span>
                                <span class="votes-display" style="display:none;">
                                    <span class="r">{{ '{:,}'.format(p.r) }}</span>-<span class="d">{{ '{:,}'.format(p.d) }}</span>
                                </span>
                            </span>
                            {% else %}&mdash;{% endif %}
                        </td>
                        <td>
                            {% if 'Governor' in topline[year] %}
                            {% set g = topline[year]['Governor'] %}
                            <span class="topline-cell {% if g.margin > 0 %}r{% else %}d{% endif %}"
                                  data-r="{{ '{:,}'.format(g.r) }}" data-d="{{ '{:,}'.format(g.d) }}"
                                  title="R: {{ '{:,}'.format(g.r) }} | D: {{ '{:,}'.format(g.d) }}">
                                <span class="margin-display">{% if g.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(g.margin|abs) }}</span>
                                <span class="votes-display" style="display:none;">
                                    <span class="r">{{ '{:,}'.format(g.r) }}</span>-<span class="d">{{ '{:,}'.format(g.d) }}</span>
                                </span>
                            </span>
                            {% else %}&mdash;{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <script>
        document.querySelectorAll('.topline-cell').forEach(cell => {
            cell.style.cursor = 'pointer';
            cell.addEventListener('click', function() {
                const margin = this.querySelector('.margin-display');
                const votes = this.querySelector('.votes-display');
                if (margin.style.display === 'none') {
                    margin.style.display = '';
                    votes.style.display = 'none';
                } else {
                    margin.style.display = 'none';
                    votes.style.display = '';
                }
            });
        });
        </script>
        {% endif %}

        {% if demographics and demographics.population %}
        <div class="sidebar-section">
            <h3>Demographics</h3>
            <table class="demo-table">
                <tr>
                    <td>Population</td>
                    <td class="text-right">{{ "{:,}".format(demographics.population) }}</td>
                </tr>
                {% if demographics.median_income %}
                <tr>
                    <td>Median Income</td>
                    <td class="text-right">${{ "{:,}".format(demographics.median_income) }}</td>
                </tr>
                {% endif %}
                {% if demographics.median_age %}
                <tr>
                    <td>Median Age</td>
                    <td class="text-right">{{ demographics.median_age }}</td>
                </tr>
                {% endif %}
                {% if demographics.college_pct %}
                <tr>
                    <td>College Degree+</td>
                    <td class="text-right">{{ demographics.college_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.homeowner_pct %}
                <tr>
                    <td>Homeowners</td>
                    <td class="text-right">{{ demographics.homeowner_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.veteran_pct %}
                <tr>
                    <td>Veterans</td>
                    <td class="text-right">{{ demographics.veteran_pct }}%</td>
                </tr>
                {% endif %}
            </table>

            <h4 style="margin-top: 1rem; font-size: 0.9rem;">Race & Ethnicity</h4>
            <table class="demo-table">
                {% if demographics.white_pct %}
                <tr>
                    <td>White</td>
                    <td class="text-right">{{ demographics.white_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.black_pct and demographics.black_pct >= 0.5 %}
                <tr>
                    <td>Black</td>
                    <td class="text-right">{{ demographics.black_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.asian_pct and demographics.asian_pct >= 0.5 %}
                <tr>
                    <td>Asian</td>
                    <td class="text-right">{{ demographics.asian_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.hispanic_pct and demographics.hispanic_pct >= 0.5 %}
                <tr>
                    <td>Hispanic/Latino</td>
                    <td class="text-right">{{ demographics.hispanic_pct }}%</td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% endif %}

        <div class="sidebar-section">
            <h3>Towns ({{ info.towns|length }})</h3>
            <ul class="town-list" style="columns: 1;">
                {% for town in info.towns %}
                <li><a href="{{ url_for('town', name=town) }}">{{ town }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const districtTowns = {{ info.towns | tojson }};

// Name normalization for unincorporated places
const nameMap = {
    'Atkinson & Gilmanton': 'Atkinson & Gilmanton Academy Grant',
    'Second College': 'Second College Grant',
    'Low & Burbanks': 'Low and Burbanks Grant',
    'Thompson & Meserve': 'Thompson and Meserves Purchase',
    "Pinkham's Grant": 'Pinkhams Grant',
    "Hart's Location": 'Harts Location',
    'Wentworths Location': "Wentworth's Location",
    "Wentworth's Location": 'Wentworths Location'
};

function normalizeGeoName(geoName) {
    return nameMap[geoName] || geoName;
}

const map = L.map('district-map', {
    zoomControl: false,
    attributionControl: false,
    dragging: false,
    touchZoom: false,
    scrollWheelZoom: false,
    doubleClickZoom: false
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    maxZoom: 19
}).addTo(map);

fetch('/static/data/nh-towns.geojson')
    .then(r => r.json())
    .then(geojson => {
        const districtFeatures = geojson.features.filter(f => {
            const geoName = f.properties.name;
            const normalizedName = normalizeGeoName(geoName);
            return districtTowns.includes(geoName) || districtTowns.includes(normalizedName);
        });

        const layer = L.geoJSON(districtFeatures, {
            style: {
                fillColor: '{% if "R" in lean %}#8b0000{% else %}#1e3a5f{% endif %}',
                weight: 1,
                opacity: 1,
                color: '#333',
                fillOpacity: 0.6
            }
        }).addTo(map);

        if (layer.getBounds().isValid()) {
            map.fitBounds(layer.getBounds(), { padding: [10, 10] });
        }
    });
</script>
{% endblock %}
