{% extends "base.html" %}

{% block title %}Election Map - NH Election Results{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
#map {
    height: 650px;
    width: 100%;
    background: #f5f5f5;
}
.map-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    align-items: end;
}
.map-controls label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}
.legend {
    background: white;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    font-size: 0.85rem;
}
.legend-title {
    font-weight: 600;
    margin-bottom: 6px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 3px;
}
.legend-color {
    width: 18px;
    height: 12px;
    border: 1px solid #999;
}
.info-box {
    background: white;
    padding: 10px 14px;
    border-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    min-width: 180px;
}
.info-box h4 {
    margin: 0 0 6px 0;
    font-size: 1rem;
    font-family: Georgia, serif;
}
.info-box p {
    margin: 0;
    font-size: 0.9rem;
}
.info-value {
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Election Map</h1>
    <p class="subtitle">Interactive district and town boundaries</p>
</div>

<div class="map-controls">
    <div>
        <label for="layer-select">View:</label>
        <select id="layer-select" onchange="changeLayer()">
            <option value="house">State House (Base Districts)</option>
            <option value="floterial">State House (Floterial Districts)</option>
            <option value="senate">State Senate Districts</option>
            <option value="exec">Executive Council</option>
            <option value="congress">Congressional Districts</option>
            <option value="towns">Towns</option>
        </select>
    </div>
    <div>
        <label for="year-select">Year:</label>
        <select id="year-select" onchange="reloadData()">
            <option value="">Average (All Years)</option>
            <option value="2024" selected>2024</option>
            <option value="2022">2022</option>
            <option value="2020">2020</option>
            <option value="2018">2018</option>
            <option value="2016">2016</option>
        </select>
    </div>
    <div>
        <label for="metric-select">Color by:</label>
        <select id="metric-select" onchange="reloadData()">
            <option value="margin">Vote Margin</option>
            <option value="pvi">PVI (Partisan Lean)</option>
        </select>
    </div>
</div>

<div id="map"></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// County code mapping used by multiple configs
const countyMap = {
    'BE': 'Belknap', 'CA': 'Carroll', 'CH': 'Cheshire',
    'CO': 'Coos', 'GR': 'Grafton', 'HI': 'Hillsborough',
    'ME': 'Merrimack', 'RO': 'Rockingham', 'ST': 'Strafford', 'SU': 'Sullivan'
};

// Helper to format house district name from code like 'BE1' or 'HI05'
function formatHouseDistrictName(code) {
    if (!code) return 'Unknown';
    const county = code.substring(0, 2);
    const num = code.substring(2).replace(/^0+/, ''); // strip leading zeros
    return `${countyMap[county] || county} ${num}`;
}

// Helper to get house district URL
function getHouseDistrictUrl(code) {
    if (!code) return null;
    const county = code.substring(0, 2);
    const num = code.substring(2).replace(/^0+/, '');
    return `/district/${countyMap[county]}/${num}`;
}

// Layer configurations for 2022+ maps (post-redistricting)
const layerConfig2022 = {
    house: {
        file: '/static/data/nh-house-base-districts.geojson',
        idField: 'basehse22',
        clickUrl: (props) => getHouseDistrictUrl(props.basehse22),
        formatName: (props) => formatHouseDistrictName(props.basehse22)
    },
    floterial: {
        file: '/static/data/nh-house-floterial-districts.geojson',
        idField: 'floathse22',
        clickUrl: (props) => getHouseDistrictUrl(props.floathse22),
        formatName: (props) => {
            const name = formatHouseDistrictName(props.floathse22);
            return name !== 'Unknown' ? `${name} (Floterial)` : 'Unknown';
        }
    },
    senate: {
        file: '/static/data/nh-senate-districts.geojson',
        idField: 'Senate2022',
        dataKeyPrefix: 'sen_',
        clickUrl: (props) => `/statewide-district/State Senator/${props.Senate2022}`,
        formatName: (props) => `Senate District ${props.Senate2022}`
    },
    exec: {
        file: '/static/data/nh-exec-council-districts.geojson',
        idField: 'ExecCo2022',
        dataKeyPrefix: 'ec_',
        clickUrl: (props) => `/statewide-district/Executive Councilor/${props.ExecCo2022}`,
        formatName: (props) => `Executive Council ${props.ExecCo2022}`
    },
    congress: {
        file: '/static/data/nh-congress-districts.geojson',
        idField: 'Cong2022',
        dataKeyPrefix: 'cong_',
        clickUrl: (props) => `/statewide-district/Representative in Congress/${props.Cong2022}`,
        formatName: (props) => `Congressional District ${props.Cong2022}`
    }
};

// Layer configurations for 2012-2020 maps (pre-redistricting)
const layerConfig2012 = {
    house: {
        file: '/static/data/nh-house-base-districts-2012.geojson',
        idField: 'NHHouse201',
        clickUrl: (props) => getHouseDistrictUrl(props.NHHouse201),
        formatName: (props) => formatHouseDistrictName(props.NHHouse201)
    },
    floterial: null, // No floterial data for old maps
    senate: {
        file: '/static/data/nh-senate-districts-2012.geojson',
        idField: 'Senate2012',
        dataKeyPrefix: 'sen_',
        clickUrl: (props) => `/statewide-district/State Senator/${props.Senate2012}`,
        formatName: (props) => `Senate District ${props.Senate2012}`
    },
    exec: {
        file: '/static/data/nh-exec-council-districts-2012.geojson',
        idField: 'EXECCO2012',
        dataKeyPrefix: 'ec_',
        clickUrl: (props) => `/statewide-district/Executive Councilor/${props.EXECCO2012}`,
        formatName: (props) => `Executive Council ${props.EXECCO2012}`
    },
    congress: {
        file: '/static/data/nh-congress-districts-2012.geojson',
        idField: 'USCongress',
        dataKeyPrefix: 'cong_',
        clickUrl: (props) => `/statewide-district/Representative in Congress/${props.USCongress}`,
        formatName: (props) => `Congressional District ${props.USCongress}`
    }
};

// Shared configs (don't change with redistricting)
const sharedLayerConfig = {
    towns: {
        file: '/static/data/nh-towns.geojson',
        idField: 'name',
        clickUrl: (props) => `/town/${encodeURIComponent(props.name)}`,
        formatName: (props) => props.name
    },
    counties: {
        file: '/static/data/nh-counties.geojson',
        idField: 'name',
        clickUrl: (props) => `/county/${encodeURIComponent(props.name || props.NAME)}`,
        formatName: (props) => `${props.name || props.NAME} County`
    }
};

// Get the appropriate layer config based on year
function getLayerConfig(layerType, year) {
    // Towns and counties don't change
    if (sharedLayerConfig[layerType]) {
        return sharedLayerConfig[layerType];
    }
    // Use 2012 maps for pre-redistricting years (2016, 2018, 2020)
    // Use 2022 maps for post-redistricting years (2022, 2024) and average
    const useOldMaps = year && ['2016', '2018', '2020'].includes(year);
    const config = useOldMaps ? layerConfig2012 : layerConfig2022;
    return config[layerType];
}

// Initialize map centered on NH (centered at geographic midpoint)
const map = L.map('map').setView([44.0, -71.5], 8);

// Add base tile layer
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap, &copy; CARTO',
    maxZoom: 19
}).addTo(map);

let geojsonLayer = null;
let electionData = {};
let currentLayer = 'house';
let currentYear = document.getElementById('year-select').value;
let currentConfig = getLayerConfig('house', currentYear);

// Color scale - red to blue
function getColor(value) {
    if (value === null || value === undefined) return '#ccc';
    return value > 30 ? '#67000d' :
           value > 20 ? '#a50f15' :
           value > 10 ? '#cb181d' :
           value > 5 ? '#ef3b2c' :
           value > 0 ? '#fb6a4a' :
           value > -5 ? '#74a9cf' :
           value > -10 ? '#3690c0' :
           value > -20 ? '#0570b0' :
           value > -30 ? '#045a8d' :
           '#023858';
}

// Normalize district code - strip leading zeros from numeric part (HI05 -> HI5)
function normalizeDistrictCode(code) {
    if (!code) return code;
    // Convert to string if it's a number (for exec council, senate, congress)
    const codeStr = String(code);
    const match = codeStr.match(/^([A-Z]+)0*(\d+)$/);
    return match ? match[1] + match[2] : codeStr;
}

function style(feature) {
    const id = feature.properties[currentConfig.idField];
    // Skip blank/null IDs
    if (!id || (typeof id === 'string' && id.trim() === '')) {
        return { fillColor: '#ccc', weight: 1, opacity: 0.5, color: '#999', fillOpacity: 0.3 };
    }
    // Build the data key with prefix if specified, normalizing district codes
    const prefix = currentConfig.dataKeyPrefix || '';
    const normalizedId = normalizeDistrictCode(id);
    const dataKey = prefix + normalizedId;
    // Try both string and numeric lookup since JSON keys are strings
    const data = electionData[dataKey] || electionData[String(dataKey)];

    // Use PVI or margin based on selected metric
    const metric = document.getElementById('metric-select').value;
    const value = data ? (metric === 'pvi' && data.pvi !== undefined ? data.pvi : data.margin) : null;

    return {
        fillColor: getColor(value),
        weight: 1,
        opacity: 1,
        color: '#666',
        fillOpacity: 0.7
    };
}

function highlightFeature(e) {
    const layer = e.target;
    layer.setStyle({
        weight: 3,
        color: '#333',
        fillOpacity: 0.85
    });
    layer.bringToFront();
    info.update(layer.feature.properties);
}

function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);
    info.update();
}

// Detect touch devices
const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
let selectedLayer = null;

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: function(e) {
            if (isTouchDevice) {
                // On mobile: first tap shows info, second tap navigates
                if (selectedLayer === layer) {
                    // Second tap - navigate
                    const url = currentConfig.clickUrl(feature.properties);
                    if (url) window.location.href = url;
                } else {
                    // First tap - show info and highlight
                    if (selectedLayer) {
                        geojsonLayer.resetStyle(selectedLayer);
                    }
                    selectedLayer = layer;
                    highlightFeature(e);
                    info.update(feature.properties);
                }
            } else {
                // Desktop: click navigates directly
                const url = currentConfig.clickUrl(feature.properties);
                if (url) window.location.href = url;
            }
        }
    });
}

// Info control
const info = L.control({position: 'topright'});
info.onAdd = function() {
    this._div = L.DomUtil.create('div', 'info-box');
    this.update();
    return this._div;
};
info.update = function(props) {
    if (!props) {
        this._div.innerHTML = '<h4>Hover over an area</h4>';
        return;
    }
    const id = props[currentConfig.idField];
    // Build the data key with prefix if specified, normalizing district codes
    const prefix = currentConfig.dataKeyPrefix || '';
    const normalizedId = normalizeDistrictCode(id);
    const dataKey = prefix + normalizedId;
    const data = electionData[dataKey] || electionData[String(dataKey)];
    const name = currentConfig.formatName(props);
    const detailUrl = currentConfig.clickUrl(props);

    const metric = document.getElementById('metric-select').value;
    let html = `<h4>${name}</h4>`;
    if (data) {
        // Show seat split for multi-seat districts
        if (data.seats && data.seats > 1) {
            html += `<p>Seats: <span class="info-value"><span style="color:#8b0000">${data.r_seats}R</span>-<span style="color:#1e3a5f">${data.d_seats}D</span></span> (${data.seats} total)</p>`;
        }

        // Show PVI if available and selected
        if (metric === 'pvi' && data.pvi !== undefined) {
            const pviSign = data.pvi > 0 ? 'R+' : 'D+';
            const pviColor = data.pvi > 0 ? '#8b0000' : '#1e3a5f';
            html += `<p>PVI: <span class="info-value" style="color:${pviColor}">${pviSign}${Math.abs(data.pvi).toFixed(1)}</span></p>`;
        }

        // Show margin
        const marginSign = data.margin > 0 ? 'R+' : 'D+';
        const marginColor = data.margin > 0 ? '#8b0000' : '#1e3a5f';
        const marginLabel = data.seats > 1 ? 'Threshold' : 'Margin';
        html += `<p>${marginLabel}: <span class="info-value" style="color:${marginColor}">${marginSign}${Math.abs(data.margin).toFixed(1)}%</span></p>`;

        // Show candidates if available (specific year selected)
        if (data.candidates && data.candidates.length > 0) {
            html += '<div style="margin:6px 0;font-size:0.85rem;">';
            data.candidates.forEach((c, i) => {
                const partyColor = c.party === 'R' ? '#8b0000' : (c.party === 'D' ? '#1e3a5f' : '#666');
                const lastName = c.name.split(' ').pop();
                const isWinner = i === 0;
                html += `<div style="color:${partyColor};${isWinner ? 'font-weight:600;' : ''}">${lastName} (${c.party}): ${c.votes?.toLocaleString() || '?'}${isWinner ? ' âœ“' : ''}</div>`;
            });
            html += '</div>';
        } else if (data.r_votes !== undefined) {
            html += `<p>R: ${data.r_votes?.toLocaleString() || '?'} / D: ${data.d_votes?.toLocaleString() || '?'}</p>`;
        }
    } else {
        html += '<p class="text-muted">No election data</p>';
    }
    // On mobile, show clickable link; on desktop, show hint
    if (isTouchDevice) {
        html += `<p style="margin-top:8px;"><a href="${detailUrl}" style="color:#1e3a5f;font-weight:600;">View Details &rarr;</a></p>`;
    } else {
        html += '<p style="font-size:0.75rem;color:#777;margin-top:4px;">Click to view details</p>';
    }
    this._div.innerHTML = html;
};
info.addTo(map);

// Legend control
const legend = L.control({position: 'bottomright'});
legend.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
        <div class="legend-title">Vote Margin</div>
        <div class="legend-item"><span class="legend-color" style="background:#67000d"></span> R+30+</div>
        <div class="legend-item"><span class="legend-color" style="background:#cb181d"></span> R+10-30</div>
        <div class="legend-item"><span class="legend-color" style="background:#fb6a4a"></span> R+0-10</div>
        <div class="legend-item"><span class="legend-color" style="background:#74a9cf"></span> D+0-10</div>
        <div class="legend-item"><span class="legend-color" style="background:#0570b0"></span> D+10-30</div>
        <div class="legend-item"><span class="legend-color" style="background:#023858"></span> D+30+</div>
    `;
    return div;
};
legend.addTo(map);

function updateColors() {
    if (geojsonLayer) {
        geojsonLayer.setStyle(style);
    }
}

function changeLayer() {
    const layerType = document.getElementById('layer-select').value;
    currentLayer = layerType;
    currentConfig = getLayerConfig(layerType, currentYear);
    if (!currentConfig) {
        // Layer not available for this year (e.g., floterial for old maps)
        alert('This layer is not available for the selected year.');
        return;
    }
    loadLayer();
}

function reloadData() {
    const year = document.getElementById('year-select').value;
    const metric = document.getElementById('metric-select').value;

    // Check if year changed and requires different map (redistricting boundary)
    const oldMapYears = ['2016', '2018', '2020'];
    const yearChanged = year !== currentYear;
    const mapChanged = yearChanged && (oldMapYears.includes(year) !== oldMapYears.includes(currentYear));
    currentYear = year;

    let url = '/api/districts-map-data?metric=' + metric;
    if (year) {
        url += '&year=' + year;
    }
    fetch(url).then(r => r.json()).then(data => {
        electionData = data;
        if (mapChanged) {
            // Year crossed redistricting boundary, reload the GeoJSON layer
            currentConfig = getLayerConfig(currentLayer, currentYear);
            if (currentConfig) {
                loadLayer();
            }
        } else {
            updateColors();
        }
    }).catch(err => {
        console.error('Error loading election data:', err);
    });
}

function loadLayer() {
    // Remove existing layer
    if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
    }

    if (!currentConfig || !currentConfig.file) {
        console.error('No config or file for layer:', currentLayer, 'year:', currentYear);
        return;
    }

    console.log('Loading layer:', currentConfig.file);

    // Load new geojson
    fetch(currentConfig.file)
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        })
        .then(geojson => {
            console.log('Loaded', geojson.features.length, 'features');
            geojsonLayer = L.geoJSON(geojson, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
            // Don't auto-fit bounds - use fixed view for consistent zoom
        })
        .catch(err => {
            console.error('Error loading layer:', currentConfig.file, err);
        });
}

// Load election data and initial layer
const initialYear = document.getElementById('year-select').value;
const initialMetric = document.getElementById('metric-select').value;
let initialUrl = '/api/districts-map-data?metric=' + initialMetric;
if (initialYear) {
    initialUrl += '&year=' + initialYear;
}
fetch(initialUrl).then(r => r.json()).then(data => {
    electionData = data;
    loadLayer();
}).catch(err => {
    console.error('Error loading election data:', err);
    loadLayer(); // Still load the layer even without election data
});
</script>
{% endblock %}
