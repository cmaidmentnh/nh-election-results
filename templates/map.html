{% extends "base.html" %}

{% block title %}Election Map - NH Election Results{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
#map {
    height: 650px;
    width: 100%;
    background: #f5f5f5;
}
.map-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    align-items: end;
}
.map-controls label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}
.legend {
    background: white;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    font-size: 0.85rem;
}
.legend-title {
    font-weight: 600;
    margin-bottom: 6px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 3px;
}
.legend-color {
    width: 18px;
    height: 12px;
    border: 1px solid #999;
}
.info-box {
    background: white;
    padding: 10px 14px;
    border-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    min-width: 180px;
}
.info-box h4 {
    margin: 0 0 6px 0;
    font-size: 1rem;
    font-family: Georgia, serif;
}
.info-box p {
    margin: 0;
    font-size: 0.9rem;
}
.info-value {
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>State House District Map</h1>
    <p class="subtitle">2024 results by district</p>
</div>

<div class="map-controls">
    <div>
        <label for="metric-select">Color by:</label>
        <select id="metric-select" onchange="updateColors()">
            <option value="margin">Vote Margin</option>
            <option value="pvi">PVI (Partisan Lean)</option>
        </select>
    </div>
</div>

<div id="map"></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Initialize map centered on NH
const map = L.map('map').setView([43.8, -71.5], 8);

// Add base tile layer (light gray for better contrast)
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap, &copy; CARTO',
    maxZoom: 19
}).addTo(map);

let geojsonLayer = null;
let electionData = {};

// Color scale - red to blue
function getColor(value) {
    // value is margin: positive = R, negative = D
    if (value === null || value === undefined) return '#ccc';
    return value > 30 ? '#67000d' :
           value > 20 ? '#a50f15' :
           value > 10 ? '#cb181d' :
           value > 5 ? '#ef3b2c' :
           value > 0 ? '#fb6a4a' :
           value > -5 ? '#74a9cf' :
           value > -10 ? '#3690c0' :
           value > -20 ? '#0570b0' :
           value > -30 ? '#045a8d' :
           '#023858';
}

function style(feature) {
    const districtCode = feature.properties.basehse22;
    const data = electionData[districtCode];
    const value = data ? data.margin : null;

    return {
        fillColor: getColor(value),
        weight: 1,
        opacity: 1,
        color: '#666',
        fillOpacity: 0.7
    };
}

function highlightFeature(e) {
    const layer = e.target;
    layer.setStyle({
        weight: 3,
        color: '#333',
        fillOpacity: 0.85
    });
    layer.bringToFront();
    info.update(layer.feature.properties);
}

function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);
    info.update();
}

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: function(e) {
            const code = feature.properties.basehse22;
            // Parse district code (e.g., "HI35" -> Hillsborough 35)
            const countyMap = {
                'BE': 'Belknap', 'CA': 'Carroll', 'CH': 'Cheshire',
                'CO': 'Coos', 'GR': 'Grafton', 'HI': 'Hillsborough',
                'ME': 'Merrimack', 'RO': 'Rockingham', 'ST': 'Strafford', 'SU': 'Sullivan'
            };
            const countyCode = code.substring(0, 2);
            const distNum = code.substring(2);
            const county = countyMap[countyCode];
            if (county) {
                window.location.href = `/district/${county}/${distNum}`;
            }
        }
    });
}

// Info control
const info = L.control({position: 'topright'});
info.onAdd = function() {
    this._div = L.DomUtil.create('div', 'info-box');
    this.update();
    return this._div;
};
info.update = function(props) {
    if (!props) {
        this._div.innerHTML = '<h4>Hover over a district</h4>';
        return;
    }
    const code = props.basehse22;
    const data = electionData[code];

    // Parse district code
    const countyMap = {
        'BE': 'Belknap', 'CA': 'Carroll', 'CH': 'Cheshire',
        'CO': 'Coos', 'GR': 'Grafton', 'HI': 'Hillsborough',
        'ME': 'Merrimack', 'RO': 'Rockingham', 'ST': 'Strafford', 'SU': 'Sullivan'
    };
    const countyCode = code.substring(0, 2);
    const distNum = code.substring(2);
    const county = countyMap[countyCode] || countyCode;

    let html = `<h4>${county} ${distNum}</h4>`;
    if (data) {
        const marginSign = data.margin > 0 ? 'R+' : 'D+';
        const marginColor = data.margin > 0 ? '#8b0000' : '#1e3a5f';
        html += `<p>Margin: <span class="info-value" style="color:${marginColor}">${marginSign}${Math.abs(data.margin).toFixed(1)}%</span></p>`;
        html += `<p>R: ${data.r_votes?.toLocaleString() || '?'} / D: ${data.d_votes?.toLocaleString() || '?'}</p>`;
    } else {
        html += '<p class="text-muted">No data</p>';
    }
    html += '<p style="font-size:0.75rem;color:#777;margin-top:4px;">Click to view details</p>';
    this._div.innerHTML = html;
};
info.addTo(map);

// Legend control
const legend = L.control({position: 'bottomright'});
legend.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
        <div class="legend-title">Vote Margin</div>
        <div class="legend-item"><span class="legend-color" style="background:#67000d"></span> R+30+</div>
        <div class="legend-item"><span class="legend-color" style="background:#cb181d"></span> R+10-30</div>
        <div class="legend-item"><span class="legend-color" style="background:#fb6a4a"></span> R+0-10</div>
        <div class="legend-item"><span class="legend-color" style="background:#74a9cf"></span> D+0-10</div>
        <div class="legend-item"><span class="legend-color" style="background:#0570b0"></span> D+10-30</div>
        <div class="legend-item"><span class="legend-color" style="background:#023858"></span> D+30+</div>
    `;
    return div;
};
legend.addTo(map);

function updateColors() {
    if (geojsonLayer) {
        geojsonLayer.setStyle(style);
    }
}

// Load data
Promise.all([
    fetch('/static/data/nh-house-districts.geojson').then(r => r.json()),
    fetch('/api/districts-map-data').then(r => r.json())
]).then(([geojson, data]) => {
    electionData = data;

    geojsonLayer = L.geoJSON(geojson, {
        style: style,
        onEachFeature: onEachFeature
    }).addTo(map);

    // Fit map to bounds
    map.fitBounds(geojsonLayer.getBounds());
}).catch(err => {
    console.error('Error loading map data:', err);
    document.getElementById('map').innerHTML = '<p style="padding:20px;color:#666;">Error loading map data. Please refresh.</p>';
});
</script>
{% endblock %}
