{% extends "base.html" %}

{% block title %}Election Map - NH Election Results{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
#map {
    height: 650px;
    width: 100%;
    background: #f5f5f5;
}
.map-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    align-items: end;
}
.map-controls label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}
.legend {
    background: white;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    font-size: 0.85rem;
}
.legend-title {
    font-weight: 600;
    margin-bottom: 6px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 3px;
}
.legend-color {
    width: 18px;
    height: 12px;
    border: 1px solid #999;
}
.info-box {
    background: white;
    padding: 10px 14px;
    border-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    min-width: 180px;
}
.info-box h4 {
    margin: 0 0 6px 0;
    font-size: 1rem;
    font-family: Georgia, serif;
}
.info-box p {
    margin: 0;
    font-size: 0.9rem;
}
.info-value {
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Election Map</h1>
    <p class="subtitle">Interactive district and town boundaries</p>
</div>

<div class="map-controls">
    <div>
        <label for="layer-select">View:</label>
        <select id="layer-select" onchange="changeLayer()">
            <option value="house">State House Districts</option>
            <option value="senate">State Senate Districts</option>
            <option value="exec">Executive Council</option>
            <option value="congress">Congressional Districts</option>
            <option value="towns">Towns</option>
        </select>
    </div>
    <div>
        <label for="metric-select">Color by:</label>
        <select id="metric-select" onchange="updateColors()">
            <option value="margin">Vote Margin</option>
            <option value="pvi">PVI (Partisan Lean)</option>
        </select>
    </div>
</div>

<div id="map"></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Layer configurations
const layerConfig = {
    house: {
        file: '/static/data/nh-house-base-districts.geojson',
        idField: 'basehse22',
        nameField: 'basehse22',
        clickUrl: (props) => {
            const code = props.basehse22;
            const countyMap = {
                'BE': 'Belknap', 'CA': 'Carroll', 'CH': 'Cheshire',
                'CO': 'Coos', 'GR': 'Grafton', 'HI': 'Hillsborough',
                'ME': 'Merrimack', 'RO': 'Rockingham', 'ST': 'Strafford', 'SU': 'Sullivan'
            };
            const countyCode = code.substring(0, 2);
            const distNum = code.substring(2);
            return `/district/${countyMap[countyCode]}/${distNum}`;
        },
        formatName: (props) => {
            const code = props.basehse22;
            const countyMap = {
                'BE': 'Belknap', 'CA': 'Carroll', 'CH': 'Cheshire',
                'CO': 'Coos', 'GR': 'Grafton', 'HI': 'Hillsborough',
                'ME': 'Merrimack', 'RO': 'Rockingham', 'ST': 'Strafford', 'SU': 'Sullivan'
            };
            return `${countyMap[code.substring(0, 2)] || code.substring(0, 2)} ${code.substring(2)}`;
        }
    },
    senate: {
        file: '/static/data/nh-senate-districts.geojson',
        idField: 'Senate2022',
        nameField: 'Senate2022',
        clickUrl: (props) => `/statewide-district/State Senator/${props.Senate2022}`,
        formatName: (props) => `Senate District ${props.Senate2022}`
    },
    exec: {
        file: '/static/data/nh-exec-council-districts.geojson',
        idField: 'ExecCo2022',
        nameField: 'ExecCo2022',
        clickUrl: (props) => `/statewide-district/Executive Councilor/${props.ExecCo2022}`,
        formatName: (props) => `Executive Council ${props.ExecCo2022}`
    },
    congress: {
        file: '/static/data/nh-congress-districts.geojson',
        idField: 'Cong2022',
        nameField: 'Cong2022',
        clickUrl: (props) => `/statewide-district/Representative in Congress/${props.Cong2022}`,
        formatName: (props) => `Congressional District ${props.Cong2022}`
    },
    towns: {
        file: '/static/data/nh-towns.geojson',
        idField: 'name',
        nameField: 'name',
        clickUrl: (props) => `/town/${encodeURIComponent(props.name)}`,
        formatName: (props) => props.name
    },
    counties: {
        file: '/static/data/nh-counties.geojson',
        idField: 'name',
        nameField: 'name',
        clickUrl: (props) => `/county/${encodeURIComponent(props.name || props.NAME)}`,
        formatName: (props) => `${props.name || props.NAME} County`
    }
};

// Initialize map centered on NH (zoom 8 is good for the whole state)
const map = L.map('map').setView([43.5, -71.5], 7.5);

// Add base tile layer
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap, &copy; CARTO',
    maxZoom: 19
}).addTo(map);

let geojsonLayer = null;
let electionData = {};
let currentLayer = 'house';
let currentConfig = layerConfig.house;

// Color scale - red to blue
function getColor(value) {
    if (value === null || value === undefined) return '#ccc';
    return value > 30 ? '#67000d' :
           value > 20 ? '#a50f15' :
           value > 10 ? '#cb181d' :
           value > 5 ? '#ef3b2c' :
           value > 0 ? '#fb6a4a' :
           value > -5 ? '#74a9cf' :
           value > -10 ? '#3690c0' :
           value > -20 ? '#0570b0' :
           value > -30 ? '#045a8d' :
           '#023858';
}

function style(feature) {
    const id = feature.properties[currentConfig.idField];
    // Try both string and numeric lookup since JSON keys are strings
    const data = electionData[id] || electionData[String(id)] || electionData[parseInt(id)];
    const value = data ? data.margin : null;

    return {
        fillColor: getColor(value),
        weight: 1,
        opacity: 1,
        color: '#666',
        fillOpacity: 0.7
    };
}

function highlightFeature(e) {
    const layer = e.target;
    layer.setStyle({
        weight: 3,
        color: '#333',
        fillOpacity: 0.85
    });
    layer.bringToFront();
    info.update(layer.feature.properties);
}

function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);
    info.update();
}

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: function(e) {
            const url = currentConfig.clickUrl(feature.properties);
            if (url) window.location.href = url;
        }
    });
}

// Info control
const info = L.control({position: 'topright'});
info.onAdd = function() {
    this._div = L.DomUtil.create('div', 'info-box');
    this.update();
    return this._div;
};
info.update = function(props) {
    if (!props) {
        this._div.innerHTML = '<h4>Hover over an area</h4>';
        return;
    }
    const id = props[currentConfig.idField];
    // Try both string and numeric lookup
    const data = electionData[id] || electionData[String(id)] || electionData[parseInt(id)];
    const name = currentConfig.formatName(props);

    let html = `<h4>${name}</h4>`;
    if (data) {
        const marginSign = data.margin > 0 ? 'R+' : 'D+';
        const marginColor = data.margin > 0 ? '#8b0000' : '#1e3a5f';
        html += `<p>Margin: <span class="info-value" style="color:${marginColor}">${marginSign}${Math.abs(data.margin).toFixed(1)}%</span></p>`;
        if (data.r_votes !== undefined) {
            html += `<p>R: ${data.r_votes?.toLocaleString() || '?'} / D: ${data.d_votes?.toLocaleString() || '?'}</p>`;
        }
    } else {
        html += '<p class="text-muted">No election data</p>';
    }
    html += '<p style="font-size:0.75rem;color:#777;margin-top:4px;">Click to view details</p>';
    this._div.innerHTML = html;
};
info.addTo(map);

// Legend control
const legend = L.control({position: 'bottomright'});
legend.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
        <div class="legend-title">Vote Margin</div>
        <div class="legend-item"><span class="legend-color" style="background:#67000d"></span> R+30+</div>
        <div class="legend-item"><span class="legend-color" style="background:#cb181d"></span> R+10-30</div>
        <div class="legend-item"><span class="legend-color" style="background:#fb6a4a"></span> R+0-10</div>
        <div class="legend-item"><span class="legend-color" style="background:#74a9cf"></span> D+0-10</div>
        <div class="legend-item"><span class="legend-color" style="background:#0570b0"></span> D+10-30</div>
        <div class="legend-item"><span class="legend-color" style="background:#023858"></span> D+30+</div>
    `;
    return div;
};
legend.addTo(map);

function updateColors() {
    if (geojsonLayer) {
        geojsonLayer.setStyle(style);
    }
}

function changeLayer() {
    const layerType = document.getElementById('layer-select').value;
    currentLayer = layerType;
    currentConfig = layerConfig[layerType];
    loadLayer();
}

function loadLayer() {
    // Remove existing layer
    if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
    }

    // Load new geojson
    fetch(currentConfig.file)
        .then(r => r.json())
        .then(geojson => {
            geojsonLayer = L.geoJSON(geojson, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
            map.fitBounds(geojsonLayer.getBounds(), { padding: [10, 10], maxZoom: 10 });
        })
        .catch(err => {
            console.error('Error loading layer:', err);
        });
}

// Load election data and initial layer
fetch('/api/districts-map-data').then(r => r.json()).then(data => {
    electionData = data;
    loadLayer();
}).catch(err => {
    console.error('Error loading election data:', err);
    loadLayer(); // Still load the layer even without election data
});
</script>
{% endblock %}
