{% extends "base.html" %}

{% block title %}NH Election Results{% endblock %}

{% block content %}
<div class="two-col">
    <!-- Main Content -->
    <div class="main-content">
        <!-- Battleground Districts -->
        <div class="section">
            <div class="section-header">
                <h2>Battleground Districts</h2>
                <a href="{{ url_for('districts_browser') }}" class="section-link">View all districts &rarr;</a>
            </div>
            <p class="text-muted mb-2">Races decided by less than 5% in {{ latest_year }}</p>

            <ul class="race-list">
                {% for race in closest_races %}
                <li class="race-item">
                    <div class="race-header">
                        <span class="race-name">{{ race.label }}</span>
                        <span class="race-margin {% if race.margin > 0 %}r{% else %}d{% endif %}">
                            {% if race.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(race.margin|abs) }}%
                        </span>
                    </div>
                    <div class="race-office">{{ race.office }}</div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Biggest Swings -->
        {% if biggest_shifts %}
        <div class="section">
            <div class="section-header">
                <h2>Biggest Swings</h2>
            </div>
            <p class="text-muted mb-2">Largest margin shifts from {{ prev_year }} to {{ latest_year }}</p>

            <table>
                <thead>
                    <tr>
                        <th>District</th>
                        <th>Office</th>
                        <th class="text-right">Shift</th>
                    </tr>
                </thead>
                <tbody>
                    {% for race in biggest_shifts %}
                    <tr>
                        <td>{{ race.label }}</td>
                        <td class="text-muted">{{ race.office }}</td>
                        <td class="text-right">
                            <span class="{% if race.shift > 0 %}r{% else %}d{% endif %}">
                                {% if race.shift > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(race.shift|abs) }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Historical Table -->
        <div class="section">
            <div class="section-header">
                <h2>Historical Results</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>House</th>
                        <th>Senate</th>
                        <th>Council</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year in years|reverse %}
                    <tr>
                        <td><strong>{{ year }}</strong></td>
                        <td>
                            {% if 'State Representative' in statewide.get(year, {}) %}
                            {% set h = statewide[year]['State Representative'] %}
                            <span class="{% if h.R > h.D %}r{% else %}d{% endif %}">{{ h.R }}-{{ h.D }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if 'State Senator' in statewide.get(year, {}) %}
                            {% set s = statewide[year]['State Senator'] %}
                            <span class="{% if s.R > s.D %}r{% else %}d{% endif %}">{{ s.R }}-{{ s.D }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if 'Executive Councilor' in statewide.get(year, {}) %}
                            {% set e = statewide[year]['Executive Councilor'] %}
                            <span class="{% if e.R > e.D %}r{% else %}d{% endif %}">{{ e.R }}-{{ e.D }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Navigation -->
        <div class="sidebar-section">
            <h3>Find a Town</h3>
            <select id="town-select" onchange="if(this.value) window.location.href='/town/' + this.value">
                <option value="">Select town...</option>
                {% for town in towns %}
                <option value="{{ town }}">{{ town }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="sidebar-section">
            <h3>Browse by County</h3>
            <select id="county-select" onchange="if(this.value) window.location.href='/county/' + this.value">
                <option value="">Select county...</option>
                {% for county in counties %}
                <option value="{{ county }}">{{ county }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Party Control -->
        <div class="sidebar-section">
            <h3>{{ latest_year }} Results</h3>
            <div class="party-control">
                {% if 'State Representative' in party_control %}
                {% set h = party_control['State Representative'] %}
                <div class="party-control-row">
                    <span class="party-control-label">House</span>
                    <span class="party-control-value">
                        <span class="r">{{ h.R }}</span>-<span class="d">{{ h.D }}</span>
                    </span>
                </div>
                {% endif %}

                {% if 'State Senator' in party_control %}
                {% set s = party_control['State Senator'] %}
                <div class="party-control-row">
                    <span class="party-control-label">Senate</span>
                    <span class="party-control-value">
                        <span class="r">{{ s.R }}</span>-<span class="d">{{ s.D }}</span>
                    </span>
                </div>
                {% endif %}

                {% if 'Executive Councilor' in party_control %}
                {% set e = party_control['Executive Councilor'] %}
                <div class="party-control-row">
                    <span class="party-control-label">Council</span>
                    <span class="party-control-value">
                        <span class="r">{{ e.R }}</span>-<span class="d">{{ e.D }}</span>
                    </span>
                </div>
                {% endif %}
            </div>

            {% if changes %}
            <div class="party-control-change">
                vs {{ prev_year }}:
                {% if changes.get('State Representative', {}).get('r_change', 0) > 0 %}
                House R+{{ changes['State Representative']['r_change'] }}
                {% elif changes.get('State Representative', {}).get('r_change', 0) < 0 %}
                House D+{{ changes['State Representative']['d_change'] }}
                {% endif %}
            </div>
            {% endif %}
        </div>
    </aside>
</div>
{% endblock %}
