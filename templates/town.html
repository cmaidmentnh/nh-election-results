{% extends "base.html" %}

{% block title %}{{ summary.name }} - NH Election Results{% endblock %}

{% block content %}
<!-- Town Header with Key Insight -->
<div class="town-header">
    <div class="town-info">
        <h1>{{ summary.name }}</h1>
        <p class="subtitle">{% if summary.county %}{{ summary.county }} County{% endif %}</p>
    </div>
    <div class="town-lean {% if 'R' in summary.lean %}republican{% elif 'D' in summary.lean %}democrat{% else %}swing{% endif %}">
        {{ summary.lean }}
    </div>
</div>

<!-- Year Navigation -->
<div class="year-nav" style="margin-bottom: 24px;">
    <span class="year-link active">{{ summary.latest_year }}</span>
    {% for year in summary.years|reverse %}
    {% if year != summary.latest_year %}
    <a href="{{ url_for('town_year', name=summary.name, year=year) }}" class="year-link">{{ year }}</a>
    {% endif %}
    {% endfor %}
</div>

<!-- Key Metrics Row -->
<div class="metrics-row">
    <div class="metric">
        <div class="metric-value {% if pvi.current_pvi > 0 %}r{% else %}d{% endif %}">
            {% if pvi.current_pvi > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(pvi.current_pvi|abs) }}
        </div>
        <div class="metric-label">{{ summary.latest_year }} PVI</div>
    </div>

    <div class="metric">
        <div class="metric-value {% if pvi.trend > 0 %}r{% else %}d{% endif %}">
            {% if pvi.trend > 0 %}+{% endif %}{{ "%.1f"|format(pvi.trend) }}
        </div>
        <div class="metric-label">PVI Trend {{ summary.years[0] }}-{{ summary.years[-1] }}</div>
    </div>

    <div class="metric">
        <div class="metric-value {% if summary.latest_margin.margin > 0 %}r{% else %}d{% endif %}">
            {% if summary.latest_margin.margin > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(summary.latest_margin.margin|abs) }}%
        </div>
        <div class="metric-label">{{ summary.latest_year }} Raw Margin</div>
    </div>

    <div class="metric">
        <div class="metric-value">{{ "{:,}".format(summary.latest_margin.total_votes) }}</div>
        <div class="metric-label">Total Votes Cast</div>
    </div>
</div>

{% if comparison %}
<!-- Change from Previous Election -->
<div class="card highlight-card" style="margin-bottom: 24px;">
    <div class="change-headline">
        <span class="change-direction {% if comparison.shift_direction == 'R' %}r{% else %}d{% endif %}">
            {% if comparison.shift_direction == 'R' %}
            Shifted Republican +{{ "%.1f"|format(comparison.margin_shift) }}
            {% elif comparison.shift_direction == 'D' %}
            Shifted Democratic +{{ "%.1f"|format(comparison.margin_shift|abs) }}
            {% else %}
            No shift
            {% endif %}
        </span>
        from {{ comparison.year1 }} to {{ comparison.year2 }}
    </div>
    <div class="change-details">
        <span>Margin: {% if comparison.margin1 > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(comparison.margin1|abs) }}% &rarr; {% if comparison.margin2 > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(comparison.margin2|abs) }}%</span>
        <span class="separator">|</span>
        <span>Turnout: {{ "{:,}".format(comparison.turnout1) }} &rarr; {{ "{:,}".format(comparison.turnout2) }} ({% if comparison.turnout_pct_change > 0 %}+{% endif %}{{ "%.1f"|format(comparison.turnout_pct_change) }}%)</span>
    </div>
</div>
{% endif %}

{% if summary.ticket_splits %}
<!-- Ticket Splitting Alert -->
<div class="card alert-card" style="margin-bottom: 24px;">
    <div class="alert-title">Ticket Splitting Detected</div>
    {% for split in summary.ticket_splits %}
    <div class="split-item">
        <strong>{{ split.year }}:</strong> {{ split.top_ticket }} voters split for {{ split.down_ballot }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- PVI Trend Chart -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <span class="card-title">PVI Trend: {{ summary.years[0] }}-{{ summary.years[-1] }}</span>
    </div>
    <div class="chart-container">
        <canvas id="pviChart"></canvas>
    </div>
    <div class="chart-note">
        PVI = Town performance vs statewide average (competitive races only). Positive = more Republican than state, Negative = more Democratic.
    </div>
    <!-- PVI by Year Table -->
    <div class="pvi-table" style="margin-top: 16px;">
        <table style="width: 100%; font-size: 14px;">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>PVI</th>
                    <th>Town R%</th>
                    <th>State R%</th>
                </tr>
            </thead>
            <tbody>
                {% for year in pvi.years|reverse %}
                {% if year in pvi.pvi_by_year %}
                {% set p = pvi.pvi_by_year[year] %}
                <tr>
                    <td>{{ year }}</td>
                    <td class="{% if p.pvi > 0 %}r{% else %}d{% endif %}">
                        {% if p.pvi > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(p.pvi|abs) }}
                    </td>
                    <td>{{ p.town_r_pct }}%</td>
                    <td>{{ p.state_r_pct }}%</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Race Results for Latest Year -->
<h2 class="section-title">{{ summary.latest_year }} Race Results</h2>

{% for race in races %}
<div class="card race-card" style="margin-bottom: 16px;">
    <div class="race-header-row">
        <div class="race-info">
            <span class="race-name">{{ race.office }}</span>
            {% if race.district %}
            <span class="race-district">District {{ race.district }}</span>
            {% endif %}
        </div>
        <div class="race-result {% if race.winner_party == 'R' %}r{% elif race.winner_party == 'D' %}d{% endif %}">
            {% if race.winner_party == 'R' %}
            R+{{ race.margin_pct }}%
            {% elif race.winner_party == 'D' %}
            D+{{ race.margin_pct|abs }}%
            {% else %}
            Tie
            {% endif %}
        </div>
    </div>

    <div class="candidates-list">
        {% for candidate in race.candidates %}
        <div class="candidate-item {% if candidate.is_winner %}winner{% endif %}">
            <span class="candidate-name">
                {{ candidate.name }}
                {% if candidate.is_winner %}<span class="winner-mark">W</span>{% endif %}
            </span>
            <span class="candidate-party {{ candidate.party|lower if candidate.party else '' }}">{{ candidate.party or '-' }}</span>
            <span class="candidate-votes">{{ "{:,}".format(candidate.votes) }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
fetch('/api/town/{{ summary.name }}/pvi')
    .then(r => r.json())
    .then(data => {
        const values = data.datasets[0].data;

        // Create bar colors based on each year's PVI value
        const barColors = values.map(v => v >= 0 ? 'rgba(230, 57, 70, 0.7)' : 'rgba(69, 123, 157, 0.7)');
        const borderColors = values.map(v => v >= 0 ? '#e63946' : '#457b9d');

        // Calculate min/max ensuring 0 is always visible
        const minVal = Math.min(...values, 0);
        const maxVal = Math.max(...values, 0);
        const padding = Math.max(Math.abs(maxVal - minVal) * 0.1, 2);

        new Chart(document.getElementById('pviChart'), {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'PVI',
                    data: values,
                    backgroundColor: barColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const val = context.raw;
                                return val >= 0 ? `R+${val.toFixed(1)}` : `D+${Math.abs(val).toFixed(1)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: 'PVI (R+ / D-)' },
                        min: minVal - padding,
                        max: maxVal + padding,
                        grid: {
                            color: (ctx) => ctx.tick.value === 0 ? '#333' : '#e0e0e0',
                            lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
