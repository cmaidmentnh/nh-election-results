{% extends "base.html" %}

{% block title %}{{ summary.name }} - NH Election Results{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        {{ summary.name }}
        <span class="lean {% if 'R' in summary.lean %}r{% else %}d{% endif %}">{{ summary.lean }}</span>
    </h1>
    <p class="subtitle">{{ summary.county }} County</p>
</div>

<div class="metrics">
    <div class="metric">
        <div class="metric-value {% if pvi.current_pvi > 0 %}r{% else %}d{% endif %}">
            {% if pvi.current_pvi > 0 %}R+{% else %}D+{% endif %}{{ "%.1f"|format(pvi.current_pvi|abs) }}
        </div>
        <div class="metric-label">PVI</div>
    </div>
    <div class="metric">
        <div class="metric-value {% if pvi.trend > 0 %}r{% else %}d{% endif %}">
            {% if pvi.trend > 0 %}+{% endif %}{{ "%.1f"|format(pvi.trend) }}
        </div>
        <div class="metric-label">Trend</div>
    </div>
    <div class="metric">
        <div class="metric-value">{{ "{:,}".format(summary.latest_margin.total_votes) }}</div>
        <div class="metric-label">Votes ({{ summary.latest_year }})</div>
    </div>
</div>

<div class="two-col">
    <div class="main-content">
        <!-- Key Races Grid -->
        {% if key_races and key_races.by_office %}
        <div class="section">
            <h2>How {{ summary.name }} Voted</h2>
            <table class="key-races">
                <thead>
                    <tr>
                        <th>Race</th>
                        {% for year in key_races.years %}
                        <th>{{ year }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for office, margins in key_races.by_office.items() %}
                    <tr>
                        <td>
                            {% if office == 'President of the United States' %}President
                            {% elif office == 'United States Senator' %}US Senate
                            {% elif office == 'Representative in Congress' %}US House
                            {% elif office == 'Executive Councilor' %}Exec Council
                            {% elif office == 'State Senator' %}State Senate
                            {% elif office == 'State Representative' %}State House
                            {% else %}{{ office }}{% endif %}
                        </td>
                        {% for year in key_races.years %}
                        <td>
                            {% if year in margins %}
                            {% set m = margins[year] %}
                            <span class="margin {% if m > 0 %}r{% else %}d{% endif %}">
                                {% if m > 0 %}R+{{ "%.0f"|format(m) }}{% else %}D+{{ "%.0f"|format(m|abs) }}{% endif %}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- PVI Chart -->
        <div class="section">
            <h2>PVI History</h2>
            <div class="chart-container">
                <canvas id="pviChart"></canvas>
            </div>
        </div>

        <!-- Race Results -->
        <div class="section">
            <div class="section-header">
                <h2>{{ summary.latest_year }} Race Results</h2>
            </div>

            <div class="year-nav">
                <span class="active">{{ summary.latest_year }}</span>
                {% for year in summary.years|reverse %}
                {% if year != summary.latest_year %}
                <a href="{{ url_for('town_year', name=summary.name, year=year) }}">{{ year }}</a>
                {% endif %}
                {% endfor %}
            </div>

            {% for race in races %}
            <div class="election-year">
                <div class="election-year-header">
                    <h3>{{ race.office }}{% if race.district %} - District {{ race.district }}{% endif %}</h3>
                    <span class="{% if race.winner_party == 'R' %}r{% else %}d{% endif %}">
                        {% if race.winner_party == 'R' %}R+{% elif race.winner_party == 'D' %}D+{% endif %}{{ "%.1f"|format(race.margin_pct|abs) }}%
                    </span>
                </div>
                <ul class="candidates">
                    {% for c in race.candidates %}
                    <li class="candidate {% if c.is_winner %}winner{% endif %}">
                        <span class="candidate-name">{{ c.name }}{% if c.is_winner %} <span class="winner-check" title="Winner">&#10003;</span>{% endif %}</span>
                        <span class="candidate-party {% if c.party == 'Republican' %}r{% elif c.party == 'Democratic' %}d{% endif %}">{{ c.party or '-' }}</span>
                        <span class="candidate-votes">{{ "{:,}".format(c.votes) }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>

    <aside class="sidebar">
        {% if representation %}
        <div class="sidebar-section">
            <h3>Current Districts</h3>
            {% for d in representation %}
            <div style="padding: 0.4rem 0; border-bottom: 1px solid var(--border);">
                <div class="text-muted" style="font-size: 0.8rem;">
                    {% if d.office == 'State Representative' %}State House
                    {% elif d.office == 'State Senator' %}State Senate
                    {% elif d.office == 'Executive Councilor' %}Exec Council
                    {% elif d.office == 'Representative in Congress' %}US Congress
                    {% else %}{{ d.office }}{% endif %}
                </div>
                <a href="{% if d.office == 'State Representative' %}{{ url_for('district', county=d.county, district=d.district) }}{% else %}{{ url_for('statewide_district', office=d.office, district=d.district) }}{% endif %}">
                    {% if d.county %}{{ d.county }} {% endif %}District {{ d.district }}
                </a>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if demographics and demographics.population %}
        <div class="sidebar-section">
            <h3>Demographics</h3>
            <table class="demo-table">
                <tr>
                    <td>Population</td>
                    <td class="text-right">{{ "{:,}".format(demographics.population) }}</td>
                </tr>
                {% if demographics.median_income %}
                <tr>
                    <td>Median Income</td>
                    <td class="text-right">${{ "{:,}".format(demographics.median_income) }}</td>
                </tr>
                {% endif %}
                {% if demographics.median_age %}
                <tr>
                    <td>Median Age</td>
                    <td class="text-right">{{ demographics.median_age }}</td>
                </tr>
                {% endif %}
                {% if demographics.college_pct %}
                <tr>
                    <td>College Degree+</td>
                    <td class="text-right">{{ demographics.college_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.homeowner_pct %}
                <tr>
                    <td>Homeowners</td>
                    <td class="text-right">{{ demographics.homeowner_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.veteran_pct %}
                <tr>
                    <td>Veterans</td>
                    <td class="text-right">{{ demographics.veteran_pct }}%</td>
                </tr>
                {% endif %}
            </table>

            <h4 style="margin-top: 1rem; font-size: 0.9rem;">Race & Ethnicity</h4>
            <table class="demo-table">
                {% if demographics.white_pct %}
                <tr>
                    <td>White</td>
                    <td class="text-right">{{ demographics.white_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.black_pct and demographics.black_pct >= 0.5 %}
                <tr>
                    <td>Black</td>
                    <td class="text-right">{{ demographics.black_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.asian_pct and demographics.asian_pct >= 0.5 %}
                <tr>
                    <td>Asian</td>
                    <td class="text-right">{{ demographics.asian_pct }}%</td>
                </tr>
                {% endif %}
                {% if demographics.hispanic_pct and demographics.hispanic_pct >= 0.5 %}
                <tr>
                    <td>Hispanic/Latino</td>
                    <td class="text-right">{{ demographics.hispanic_pct }}%</td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% endif %}

        <div class="sidebar-section">
            <h3>County</h3>
            <a href="{{ url_for('county', name=summary.county) }}">{{ summary.county }} County</a>
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script>
fetch('/api/town/{{ summary.name }}/pvi')
    .then(r => r.json())
    .then(data => {
        const values = data.datasets[0].data;
        const barColors = values.map(v => v >= 0 ? '#8b0000' : '#1e3a5f');

        new Chart(document.getElementById('pviChart'), {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'PVI',
                    data: values,
                    backgroundColor: barColors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        title: { display: true, text: 'PVI (R+ / D-)' },
                        grid: { color: ctx => ctx.tick.value === 0 ? '#333' : '#eee' }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
