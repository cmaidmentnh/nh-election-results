{% extends "admin/base.html" %}

{% block title %}Enter Results - {{ race.county }} {{ race.district }}{% endblock %}

{% block content %}
<style>
    .container { max-width: none; }
    .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    #results-table { border-collapse: collapse; }
    #results-table th, #results-table td { padding: 0.4rem 0.5rem; white-space: nowrap; font-size: 14px; }
    #results-table input { width: 60px; text-align: right; padding: 0.3rem; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    #results-table th:first-child { text-align: left; position: sticky; left: 0; background: #f5f5f5; z-index: 1; min-width: 120px; }
    #results-table td:first-child { position: sticky; left: 0; background: white; min-width: 120px; }
    #results-table tbody tr:nth-child(odd) td:first-child { background: #fafafa; }
    #results-table tbody tr:hover { background: #f0f7ff; }
    @media (max-width: 768px) {
        .container { padding: 0.5rem; }
        #results-table th, #results-table td { padding: 0.3rem; font-size: 12px; }
        #results-table input { width: 50px; font-size: 14px; padding: 0.4rem 0.2rem; }
        #results-table th:first-child, #results-table td:first-child { min-width: 100px; }
        h2 { font-size: 1.1rem; }
    }
</style>
<p><a href="{{ url_for('entry.election_races', election_id=race.election_id) }}">&larr; Back to Races</a></p>

<h2>{{ race.office_name }} - {% if race.county %}{{ race.county }} {% endif %}District {{ race.district }}</h2>
<p class="text-muted">{{ race.year }} {{ race.election_type }}{% if race.election_party %} ({{ race.election_party }}){% endif %}</p>

{% if not candidates %}
<div class="card">
    <p class="text-muted">No candidates have been added to this race yet. An admin needs to add candidates first.</p>
</div>
{% else %}

<div class="card">
    <h3>Enter Vote Counts</h3>
    <p class="text-small text-muted" style="margin-bottom: 1rem;">Enter votes for each candidate in each town. Changes save automatically.</p>

    <div class="table-wrapper">
    <table id="results-table">
        <thead>
            <tr>
                <th>Candidate</th>
                {% for town in towns %}
                <th style="text-align: center;">{{ town }}</th>
                {% endfor %}
                <th style="text-align: center;">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for c in candidates %}
            <tr data-candidate="{{ c.id }}">
                <td><strong>{{ c.name }}</strong> <span style="{% if c.party == 'Republican' %}color:#8b0000{% elif c.party == 'Democratic' %}color:#1e3a5f{% endif %}">({{ c.party[0] if c.party else '?' }})</span></td>
                {% for town in towns %}
                <td style="text-align: center;">
                    <input type="number"
                           class="vote-input"
                           data-town="{{ town }}"
                           data-candidate="{{ c.id }}"
                           value="{{ results.get(town, {}).get(c.id, 0) }}"
                           min="0">
                </td>
                {% endfor %}
                <td class="row-total" data-candidate="{{ c.id }}" style="text-align: center; font-weight: 600;">0</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="font-weight: 600; background: #f5f5f5;">
                <td>TOTAL</td>
                {% for town in towns %}
                <td class="col-total" data-town="{{ town }}" style="text-align: center;">0</td>
                {% endfor %}
                <td id="grand-total" style="text-align: center;">0</td>
            </tr>
        </tfoot>
    </table>
    </div>
</div>

<div class="card">
    <div id="save-status" style="padding: 0.5rem; text-align: center;">
        <span class="text-muted">Changes save automatically</span>
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
const raceId = {{ race.id }};
let saveTimeout = null;

function updateTotals() {
    // Row totals (per candidate)
    document.querySelectorAll('#results-table tbody tr').forEach(row => {
        let total = 0;
        row.querySelectorAll('.vote-input').forEach(input => {
            total += parseInt(input.value) || 0;
        });
        row.querySelector('.row-total').textContent = total.toLocaleString();
    });

    // Column totals (per town)
    const towns = [...new Set([...document.querySelectorAll('.vote-input')].map(i => i.dataset.town))];
    towns.forEach(town => {
        let total = 0;
        document.querySelectorAll(`.vote-input[data-town="${town}"]`).forEach(input => {
            total += parseInt(input.value) || 0;
        });
        document.querySelector(`.col-total[data-town="${town}"]`).textContent = total.toLocaleString();
    });

    // Grand total
    let grandTotal = 0;
    document.querySelectorAll('.vote-input').forEach(input => {
        grandTotal += parseInt(input.value) || 0;
    });
    document.getElementById('grand-total').textContent = grandTotal.toLocaleString();
}

function saveResults() {
    const results = [];
    document.querySelectorAll('.vote-input').forEach(input => {
        results.push({
            town: input.dataset.town,
            candidate_id: parseInt(input.dataset.candidate),
            votes: parseInt(input.value) || 0
        });
    });

    document.getElementById('save-status').innerHTML = '<span style="color: #666;">Saving...</span>';

    fetch(`/entry/race/${raceId}/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ results: results })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('save-status').innerHTML = '<span style="color: #166534;">Saved!</span>';
            setTimeout(() => {
                document.getElementById('save-status').innerHTML = '<span class="text-muted">Changes save automatically</span>';
            }, 2000);
        } else {
            document.getElementById('save-status').innerHTML = '<span style="color: #8b0000;">Error saving</span>';
        }
    })
    .catch(err => {
        document.getElementById('save-status').innerHTML = '<span style="color: #8b0000;">Error: ' + err + '</span>';
    });
}

document.querySelectorAll('.vote-input').forEach(input => {
    input.addEventListener('input', () => {
        updateTotals();
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveResults, 1000);
    });
});

// Initial totals
updateTotals();
</script>
{% endblock %}
